<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>{{ page.title }} | Formid'Alpes</title>
    
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <link rel="stylesheet" href="/style.css"> 
    
    </head>
<body>
    <header>
        {% include header.html %}
    </header>

    <main>
        {{ content }}
    </main>

    <footer>
        {% include footer.html %}
    </footer>
    
	<script>
		// --- FONCTION POUR CHARGER LES TÉMOIGNAGES DE GOOGLE SHEETS ---

// 1. L'URL JSON que vous devez utiliser
const JSON_FEED_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSH664zy7-EuWIs3doKS8tsZhstJh0rWrYWBKWKpugsIEpabix6ZWmTKhCK-O_Md9czA2RmVncwgo5O/pubgviz/tq?gid=1525314360'; 
const MAX_TEMOIGNAGES = 3; // Nombre de témoignages à afficher

// Important : Ces noms DOIVENT correspondre EXACTEMENT aux en-têtes de colonnes de votre Google Sheet
// Ex : Si votre colonne est 'Nom Stagiaire', vous utilisez 'NomStagiaire' (sans espaces, CamelCase)
const COLUMN_MAPPINGS = {
    'Satisfaction globale': 'c14', // Adaptez c0, c1, etc. aux index de vos colonnes dans Sheets
    'Commentaire ou remarques concernant cette formation:': 'c17',
    'Prénom': 'c2',
    'Formation suivie': 'c4'
    // Vous devez ajuster c0, c1, c2, c3 en fonction de la position (index) des colonnes dans votre feuille.
    // c0 = première colonne, c1 = deuxième colonne, etc.
};

function chargerTemoignages() {
    const container = document.getElementById('temoignages-recent');
    if (!container) return; 

    // Nettoyage de l'ancienne balise de chargement
    container.innerHTML = `<p style="text-align: center;">Chargement des avis en cours...</p>`;

    // Google renvoie le JSON enveloppé dans une fonction (générant des erreurs si non traité)
    fetch(JSON_FEED_URL)
        .then(response => response.text())
        .then(text => {
            // *** CORRECTION FINALE pour gérer l'enveloppe de la fonction, en ignorant les espaces blancs ***
            
            // 1. Rend le texte sur une seule ligne et supprime les espaces multiples pour faciliter la recherche
            const cleanText = text.replace(/\s+/g, ' '); 
            
            // 2. Utilise une expression régulière pour trouver l'objet JSON après setResponse(
            //    Note : nous avons retiré le point-virgule final pour plus de robustesse.
            const match = cleanText.match(/google\.visualization\.Query\.setResponse\((.*)\)/);
            
            if (!match || match.length < 2) {
                // Si l'expression régulière ne trouve rien, on lance une erreur explicite
                throw new Error("Impossible d'extraire le JSON. Veuillez vérifier l'URL de publication de la feuille.");
            }
            
            // 3. Le JSON pur est dans le deuxième élément du tableau 'match'
            const jsonText = match[1].trim(); // On retire les espaces restants
            
            // 4. Parse le JSON
            const data = JSON.parse(jsonText);
            
            // 5. Récupère les lignes de données
            const rows = data.table.rows;
            
            // 6. Convertit les lignes en objets lisibles
            const temoignages = rows.map(row => {
                // Les données sont dans row.c[index de colonne].v (v pour value)
                return {
                    rating: row.c[14] ? row.c[14].v : null,
                    text: row.c[17] ? row.c[17].v : 'Appréciation non fournie',
                    name: row.c[2] ? row.c[2].v : 'Anonyme',
                    city: row.c[4] ? row.c[4].v : ''
                };
            });
            
            // Inverse l'ordre pour afficher les plus récents en premier (si Sheets trie par défaut par date)
            const responses = temoignages.reverse(); 
            
            // Vider le conteneur et afficher
            container.innerHTML = '';
            
            // Afficher les N derniers
            const temoignagesAAfficher = responses.slice(0, MAX_TEMOIGNAGES);

            temoignagesAAfficher.forEach(t => {
                // Fonction pour convertir la note numérique en étoiles (assumant une note sur 5 ou 10)
                const note = parseInt(t.rating || 0);
                const stars = '⭐'.repeat(Math.round(note / 2)); // Adapté si la note est sur 10

                const html = `
                    <div class="testimonial-item fade-in visible">
                        <div class="testimonial-content">
                            <p><strong>${stars} (${note}/10)</strong></p>
                            <p>"${t.text}"</p>
                            <div class="testimonial-author">
                                <strong>${t.name}</strong>
                                <span>${t.city}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        })
        .catch(error => {
            console.error("Erreur lors du chargement des témoignages:", error);
            container.innerHTML = `<p style="text-align: center; color: red;">Désolé, impossible de charger les avis pour le moment. (${error.message})</p>`;
        });
}

// Lancer le chargement une fois que le reste de la page est prêt
window.addEventListener('load', chargerTemoignages);
        // Smooth scrolling for navigation links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Fade in animation on scroll
        function animateOnScroll() {
            const elements = document.querySelectorAll('.fade-in');
            elements.forEach(element => {
                const elementTop = element.getBoundingClientRect().top;
                const elementVisible = 150;
                
                if (elementTop < window.innerHeight - elementVisible) {
                    element.classList.add('visible');
                }
            });
        }

        window.addEventListener('scroll', animateOnScroll);
        animateOnScroll(); // Initial check
       
                          
        // Header background on scroll
        window.addEventListener('scroll', () => {
            const header = document.querySelector('header');
            
            // Si le défilement est supérieur à 100 pixels
            if (window.scrollY > 100) {
                // AJOUTE la classe CSS 'scrolled-header'
                header.classList.add('scrolled-header');
            } else {
                // RETIRE la classe CSS 'scrolled-header'
                header.classList.remove('scrolled-header');
            }
        });
    </script>
    </body>
</html>